# Chatbot and User Control Functionality

This document describes the chatbot and user control functionality added to the "Legend of Theseus and Minotaur" game.

## Overview

The game provides two ways to control characters:

1. **AI Control**: The chatbot functionality allows AI to silently take control over selected characters in the game. When a character is under AI control, their dialogue responses are generated by an AI model (by default, OpenAI's API) based on the character's attributes and the conversation context.

2. **User Control**: The user control functionality allows players to assume control over selected characters. When a character is under user control, the player is presented with AI-generated response options when the character is addressed in a conversation. The player can choose from these options, type their own response, or skip responding.

## Components

### Chatbot Class

The `Chatbot` class in `chatbot.py` provides the core functionality for AI-controlled characters:

- Associates a chatbot with a character
- Manages conversation history
- Activates/deactivates AI control
- Generates responses using an AI adapter

### UserControl Class

The `UserControl` class in `user_control.py` provides the core functionality for user-controlled characters:

- Associates a user control with a character
- Manages conversation history
- Activates/deactivates user control
- Generates response options using an AI adapter
- Presents options to the user and handles their choices

### AI Adapters

The system uses an adapter pattern to support different AI services for both chatbot and user control:

- `AIAdapter`: Abstract base class defining the interface for AI adapters
- `OpenAIAdapter`: Implementation for OpenAI's API (default)
- Custom adapters can be created by implementing the `AIAdapter` interface

### AI_ASSUME_CONTROL Event

A new event type `AI_ASSUME_CONTROL` has been added to the game's event system. When this event is triggered, the specified character is silently placed under AI control.

### USER_ASSUME_CONTROL Event

A new event type `USER_ASSUME_CONTROL` has been added to the game's event system. When this event is triggered, the specified character is placed under user control, allowing the player to choose responses when the character is addressed.

## Usage

### AI Control

#### In JSON Day Files

To make a character AI-controlled, add an `ai_assume_control` event to a day file:

```json
{
  "event_type": "ai_assume_control",
  "character": "CharacterName"
}
```

#### Programmatically

To programmatically make a character AI-controlled:

```python
from event import Event, EventType
from character import Character

# Create an AI_ASSUME_CONTROL event
event = Event(
    event_type=EventType.AI_ASSUME_CONTROL,
    actor=my_character  # The character to be controlled by AI
)

# Apply the event to the group
event.apply(my_group)
```

### User Control

#### In JSON Day Files

To make a character user-controlled, add a `user_assume_control` event to a day file:

```json
{
  "event_type": "user_assume_control",
  "character": "CharacterName"
}
```

#### Programmatically

To programmatically make a character user-controlled:

```python
from event import Event, EventType
from character import Character

# Create a USER_ASSUME_CONTROL event
event = Event(
    event_type=EventType.USER_ASSUME_CONTROL,
    actor=my_character  # The character to be controlled by the user
)

# Apply the event to the group
event.apply(my_group)
```

## How It Works

### AI Control

1. When an `AI_ASSUME_CONTROL` event is applied to a group:
   - A chatbot is created for the character if one doesn't exist
   - The chatbot is activated to take control of the character

2. When dialogue occurs in the game:
   - All active chatbots record the dialogue in their conversation history
   - If a character with an active chatbot is addressed, the chatbot generates a response
   - The generated response is applied as a new dialogue line from the character

3. The chatbot generates responses based on:
   - The character's attributes (leadership, intelligence, resilience)
   - The character's current emotion
   - The character's relationships (friends/enemies)
   - The conversation history

### User Control

1. When a `USER_ASSUME_CONTROL` event is applied to a group:
   - A UserControl is created for the character if one doesn't exist
   - The UserControl is activated to allow the user to control the character

2. When dialogue occurs in the game:
   - All active UserControls record the dialogue in their conversation history
   - If a character with an active UserControl is addressed:
     - The UserControl generates multiple response options using the AI adapter
     - The options are presented to the user
     - The user can choose an option, type their own response, or skip
     - The selected response is applied as a new dialogue line from the character

3. The response options are generated based on:
   - The character's attributes (leadership, intelligence, resilience)
   - The character's current emotion
   - The character's relationships (friends/enemies)
   - The conversation history

4. The user has three choices when presented with response options:
   - Select one of the AI-generated options
   - Type a custom response
   - Skip responding (letting another character respond instead)

## Configuration

The OpenAI adapter requires an API key, which can be provided in two ways:

1. Set the `OPENAI_API_KEY` environment variable
2. Pass the API key directly when creating the adapter:

```python
from chatbot import Chatbot, OpenAIAdapter
from user_control import UserControl

# For AI control
adapter = OpenAIAdapter(api_key="your-api-key")
chatbot = Chatbot(some_character, adapter=adapter)

# For user control
user_control = UserControl(some_character, adapter=adapter)
```

The same adapter can be used for both AI control and user control, allowing you to use the same AI service for both functionalities.

## Customization

### Custom AI Adapters

To create a custom AI adapter, implement the `AIAdapter` interface:

```python
from chatbot import AIAdapter

class CustomAdapter(AIAdapter):
    def generate_response(self, character, context, prompt=None):
        # Custom implementation to generate a response
        return "Generated response"
```

The same custom adapter can be used for both AI control and user control.

### Prompt Customization

When generating a response or response options, you can provide an optional prompt to guide the AI:

```python
# For AI control
response = chatbot.generate_response(prompt="Make the response more sarcastic")

# For user control
options = user_control.generate_response_options(prompt="Make the options more diplomatic")
```

## Example Scripts

Two example scripts are provided to demonstrate the functionality:

1. `example_chatbot.py`: Demonstrates AI control using the `AI_ASSUME_CONTROL` event
2. `example_user_control.py`: Demonstrates user control using the `USER_ASSUME_CONTROL` event

These scripts show how to use the functionality in a simple scenario and can be used as a starting point for your own implementation.